# RSI Divergence
# Drew Griffith

#hint: signal if the rsi is in a divergence using RSI Histogram.

declare lower;
input rsi_length = 14;
input ntrend = 60;
input ma_length = 60;
input rsi_OB = 20;
input rsi_OS = -20;

# global definitions
def hi = high;
def lo = low;
def cl = close;

def rsi = Round(RSI(length = rsi_length, price = cl), 1);
def rsi_ma = Round(ExpAverage(rsi, length = ma_length), 1);
plot diff = Round(rsi - rsi_ma, 0);
diff.SetPaintingStrategy(PaintingStrategy.HISTOGRAM);
diff.SetLineWeight(3);
Diff.DefineColor("Positive and Up", Color.GREEN);
Diff.DefineColor("Positive and Down", Color.DARK_GREEN);
Diff.DefineColor("Negative and Down", Color.RED);
Diff.DefineColor("Negative and Up", Color.DARK_RED);
Diff.AssignValueColor(if Diff >= 0 then if Diff > Diff[1] then Diff.color("Positive and Up") else Diff.color("Positive and Down") else if Diff < Diff[1] then Diff.color("Negative and Down") else Diff.color("Negative and Up"));
Diff.AssignValueColor(if Diff >= 0 then if Diff > Diff[1] then Diff.color("Positive and Up") else Diff.color("Positive and Down") else if Diff < Diff[1] then Diff.color("Negative and Down") else Diff.color("Negative and Up"));

# bearish divergence definitions
plot strat_hh = Round(Highest(diff, ntrend));  #round to nearest whole number
strat_hh.SetDefaultColor(Color.DARK_GRAY);
strat_hh.SetLineWeight(1);

# bullish divergence definitions
plot strat_ll = Round(Lowest(diff, ntrend));  #round to nearest whole number
strat_ll.SetDefaultColor(Color.DARK_GRAY);
strat_ll.SetLineWeight(1);

plot diff_high = rsi_OB;
diff_high.SetDefaultColor(Color.DARK_GRAY);
diff_high.SetLineWeight(1);
diff_high.Hide();
diff_high.HideTitle();

plot diff_low = rsi_OS;
diff_low.SetDefaultColor(Color.DARK_GRAY);
diff_low.SetLineWeight(1);
diff_low.Hide();
diff_low.HideTitle();

def rsitrend_ma = Round(movavgExponential(diff, ntrend), 2);
plot rsitrend_ma_div = round(rsitrend_ma-rsitrend_ma[(ntrend/2)-1],1);
rsitrend_ma_div.SetLineWeight(1);
rsitrend_ma_div.AssignValueColor(if rsitrend_ma_div > 1 then color.green
else if rsitrend_ma_div < -1 then color.red else color.gray);
#rsitrend_ma_div.Hide();
#rsitrend_ma_div.HideTitle();
AddLabel(yes, if rsitrend_ma_div > 1 then "Trend Improving: " + rsitrend_ma_div
else if rsitrend_ma_div < -1 then "Trend Declining: " + rsitrend_ma_div else "Trend is flat: " + rsitrend_ma_div, if rsitrend_ma_div > 1 then color.green
else if rsitrend_ma_div < -1 then color.red else color.gray);
